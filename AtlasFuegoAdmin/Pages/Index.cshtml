@page
@model IndexModel
@{
    ViewData["Title"] = "Registros FUEGO";
}

<style>
    .stat-box {
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 10px;
    }
    .stat-num {
        font-size: 32px;
        font-weight: 700;
    }
    .foto-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #555;
        transition: transform 0.2s;
    }
    .foto-thumb:hover {
        transform: scale(1.3);
        border-color: #ff6600;
    }
</style>

<div class="container-fluid py-3">
    <h4 class="mb-3"><i class="fas fa-fire text-danger me-2"></i>Atlas FUEGO - Registros</h4>

    <div class="row mb-3">
        <div class="col">
            <div class="stat-box bg-primary text-white">
                <div class="stat-num">@Model.Registros.Count</div>
                <div>Total Registros</div>
            </div>
        </div>
        <div class="col">
            <div class="stat-box bg-success text-white">
                <div class="stat-num">@Model.Registros.Count(r => r.Asistira)</div>
                <div>Asistiran</div>
            </div>
        </div>
        <div class="col">
            <div class="stat-box bg-warning text-dark">
                <div class="stat-num">@Model.Registros.Count(r => r.FotoRuta != null)</div>
                <div>Con Foto</div>
            </div>
        </div>
        <div class="col">
            <div class="stat-box bg-info text-white">
                <div class="stat-num">@Model.Registros.Count(r => r.Confirmado)</div>
                <div>Check-in</div>
            </div>
        </div>
        <div class="col">
            <div class="stat-box text-white" style="background-color:#8B4513;">
                <div class="stat-num">@Model.Registros.Count(r => r.RegistroEnEscritorio)</div>
                <div>Front Desk</div>
            </div>
        </div>
    </div>

    <div class="mb-3 d-flex gap-2">
        <input type="text" id="filtro" class="form-control" placeholder="Buscar por nombre o empresa..." oninput="filtrar()" />
        <a href="/?handler=ExportExcel" class="btn btn-success text-nowrap"><i class="fas fa-file-excel me-1"></i>Exportar Excel</a>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tabla-registros">
            <thead class="table-dark">
                <tr>
                    <th>Foto</th>
                    <th>Nombre</th>
                    <th>Empresa</th>
                    <th>Email</th>
                    <th>Asistira</th>
                    <th>Check-in</th>
                    <th>Hora Registro</th>
                    <th>Hora Check-in</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.Registros)
            {
                <tr class="registro-row" data-nombre="@r.NombreCompleto.ToLower()" data-empresa="@r.Empresa.ToLower()">
                    <td>
                        @if (r.FotoRuta != null)
                        {
                            <img src="@Model.FotoBaseUrl@r.FotoRuta" class="foto-thumb" onclick="mostrarFoto(this.src, '@r.NombreCompleto')" title="Click para ver" />
                        }
                        else
                        {
                            <span class="badge bg-secondary">Sin foto</span>
                        }
                    </td>
                    <td>@r.NombreCompleto</td>
                    <td>@r.Empresa</td>
                    <td>@r.Email</td>
                    <td>
                        @if (r.Asistira)
                        {
                            <span class="badge bg-success">Si</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">No</span>
                        }
                    </td>
                    <td>
                        @if (r.Confirmado)
                        {
                            <span class="badge bg-success">Llego</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        }
                    </td>
                    <td class="fecha-utc" data-utc="@r.FechaRegistro.ToString("o")">@r.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</td>
                    <td class="fecha-utc" data-utc="@(r.FechaConfirmacion?.ToString("o") ?? "")">@(r.FechaConfirmacion?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Foto -->
<div class="modal fade" id="fotoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fotoModalLabel">Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="fotoModalImg" class="img-fluid rounded" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="/js/app-menu.js"></script>
<script>
    // Convertir fechas UTC a hora local del navegador
    document.querySelectorAll('.fecha-utc').forEach(el => {
        const utcStr = el.dataset.utc;
        if (utcStr) {
            const fecha = new Date(utcStr.endsWith('Z') ? utcStr : utcStr + 'Z');
            const dia = fecha.getDate().toString().padStart(2, '0');
            const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
            const anio = fecha.getFullYear();
            const hora = fecha.getHours().toString().padStart(2, '0');
            const min = fecha.getMinutes().toString().padStart(2, '0');
            el.textContent = `${dia}/${mes}/${anio} ${hora}:${min}`;
        }
    });

    function filtrar() {
        const term = document.getElementById('filtro').value.toLowerCase();
        document.querySelectorAll('.registro-row').forEach(row => {
            const nombre = row.dataset.nombre;
            const empresa = row.dataset.empresa;
            row.style.display = (nombre.includes(term) || empresa.includes(term)) ? '' : 'none';
        });
    }

    function mostrarFoto(src, nombre) {
        document.getElementById('fotoModalLabel').textContent = nombre;
        document.getElementById('fotoModalImg').src = src;
        new bootstrap.Modal(document.getElementById('fotoModal')).show();
    }
</script>
}
