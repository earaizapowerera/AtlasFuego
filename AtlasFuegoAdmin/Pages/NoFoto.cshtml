@page
@model NoFotoModel
@{
    ViewData["Title"] = "Sin Foto - Envío de Correos";
}

<style>
    .stat-box {
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 10px;
    }
    .stat-num {
        font-size: 32px;
        font-weight: 700;
    }
    .btn-enviar {
        background-color: #cc4400;
        border-color: #cc4400;
        color: #fff;
    }
    .btn-enviar:hover {
        background-color: #b33c00;
        border-color: #b33c00;
        color: #fff;
    }
    .btn-enviar:disabled {
        background-color: #666;
        border-color: #666;
    }
</style>

<div class="container-fluid py-3">
    <h4 class="mb-3"><i class="fas fa-envelope text-danger me-2"></i>Envío de Correo - Sin Foto</h4>

    <div class="row mb-3">
        <div class="col-md-4">
            <div class="stat-box bg-danger text-white">
                <div class="stat-num">@Model.TotalSinFoto</div>
                <div>Sin Foto (Asistirán)</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-box bg-success text-white">
                <div class="stat-num">@Model.CorreoEnviado</div>
                <div>Correo Enviado</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-box bg-warning text-dark">
                <div class="stat-num">@Model.CorreoPendiente</div>
                <div>Correo Pendiente</div>
            </div>
        </div>
    </div>

    <div class="mb-3 d-flex gap-2 align-items-center">
        <input type="text" id="filtro" class="form-control" placeholder="Buscar por nombre o empresa..." oninput="filtrar()" />
        @if (Model.CorreoPendiente > 0)
        {
            <button class="btn btn-enviar text-nowrap" onclick="enviarTodos()" id="btnEnviarTodos">
                <i class="fas fa-paper-plane me-1"></i>Enviar a Todos (@Model.CorreoPendiente)
            </button>
        }
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tabla-nofoto">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Empresa</th>
                    <th>Email</th>
                    <th>Correo Enviado</th>
                    <th>Fecha Registro</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
            @{ var idx = 0; }
            @foreach (var r in Model.SinFoto)
            {
                idx++;
                <tr class="registro-row" data-nombre="@r.NombreCompleto.ToLower()" data-empresa="@r.Empresa.ToLower()" id="row-@r.Id">
                    <td>@idx</td>
                    <td>@r.NombreCompleto</td>
                    <td>@r.Empresa</td>
                    <td>@r.Email</td>
                    <td id="status-@r.Id">
                        @if (r.CorreoNoFotoEnviado)
                        {
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Enviado</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        }
                    </td>
                    <td class="fecha-utc" data-utc="@r.FechaRegistro.ToString("o")">@r.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        @if (!r.CorreoNoFotoEnviado)
                        {
                            <button class="btn btn-sm btn-enviar" onclick="enviarUno(@r.Id, this)" id="btn-@r.Id">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        }
                        else
                        {
                            <span class="text-muted"><i class="fas fa-check-circle text-success"></i></span>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>

@section Scripts {
<script>
    document.querySelectorAll('.fecha-utc').forEach(el => {
        const utcStr = el.dataset.utc;
        if (utcStr) {
            const fecha = new Date(utcStr);
            const dia = fecha.getDate().toString().padStart(2, '0');
            const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
            const anio = fecha.getFullYear();
            const hora = fecha.getHours().toString().padStart(2, '0');
            const min = fecha.getMinutes().toString().padStart(2, '0');
            el.textContent = `${dia}/${mes}/${anio} ${hora}:${min}`;
        }
    });

    function filtrar() {
        const term = document.getElementById('filtro').value.toLowerCase();
        document.querySelectorAll('.registro-row').forEach(row => {
            const nombre = row.dataset.nombre;
            const empresa = row.dataset.empresa;
            row.style.display = (nombre.includes(term) || empresa.includes(term)) ? '' : 'none';
        });
    }

    function mostrarToast(titulo, mensaje, exito) {
        document.getElementById('toast-title').textContent = titulo;
        document.getElementById('toast-body').textContent = mensaje;
        const toastEl = document.getElementById('toast');
        toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
        if (exito) {
            toastEl.classList.add('bg-success', 'text-white');
        } else {
            toastEl.classList.add('bg-danger', 'text-white');
        }
        new bootstrap.Toast(toastEl, { delay: 4000 }).show();
    }

    async function enviarUno(id, btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const resp = await fetch('/NoFoto?handler=Enviar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token || ''
                },
                body: JSON.stringify({ id: id })
            });
            const data = await resp.json();

            if (data.success) {
                document.getElementById('status-' + id).innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Enviado</span>';
                btn.outerHTML = '<span class="text-muted"><i class="fas fa-check-circle text-success"></i></span>';
                mostrarToast('Enviado', 'Correo enviado a ' + data.nombre, true);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                mostrarToast('Error', data.message, false);
            }
        } catch (e) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            mostrarToast('Error', 'Error de conexión', false);
        }
    }

    async function enviarTodos() {
        const btn = document.getElementById('btnEnviarTodos');
        if (!confirm('¿Enviar correo a todos los pendientes?')) return;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const resp = await fetch('/NoFoto?handler=EnviarTodos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token || ''
                }
            });
            const data = await resp.json();

            if (data.success) {
                mostrarToast('Completado', `${data.enviados} correos enviados` + (data.errores?.length ? `, ${data.errores.length} errores` : ''), data.errores?.length === 0);
                setTimeout(() => location.reload(), 2000);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar a Todos';
                mostrarToast('Error', 'Error al enviar correos', false);
            }
        } catch (e) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Enviar a Todos';
            mostrarToast('Error', 'Error de conexión', false);
        }
    }
</script>
}
